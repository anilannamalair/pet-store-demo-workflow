#!/bin/bash
set -xeuo pipefail
source bootstrap.env

oc login -s openshift-311.itci.conjur.net:8443 -u $OPENSHIFT_USERNAME -p $OPENSHIFT_PASSWORD

# Deploy k8s conjur environment
pushd .
cd $K8S_CONJUR_DEPLOY_PROJECT_FOLDER
./start
popd

. set_env_vars.sh

./0_check_dependencies.sh

./stop

./1_create_test_app_namespace.sh

if [[ "${DEPLOY_MASTER_CLUSTER}" = "true" ]]; then
  # Only automatically run these scripts for dev/demo envs deploying a master
  # cluster directly to k8s/oc
  ./2_load_conjur_policies.sh
  ./3_init_conjur_cert_authority.sh
fi

## To complete the flow of pet-store-demo, make the following steps from outside
# cd ../../
# ./bin/build
# ./bin/deploy

## To test deployed pet-store
# curl http://pet-store-env-$PROJECT_NAME.openshift-311.itci.conjur.net/pets

